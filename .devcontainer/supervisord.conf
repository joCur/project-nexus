[supervisord]
nodaemon=false
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[program:postgresql]
command=/usr/lib/postgresql/15/bin/postgres -D /var/lib/postgresql/data -c config_file=/etc/postgresql/15/main/postgresql.conf
user=postgres
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/supervisor/postgresql.log
environment=POSTGRES_DB="nexus_db",POSTGRES_USER="nexus",POSTGRES_PASSWORD="nexus_secure_2024"

[program:postgresql-setup]
command=/bin/bash -c "sleep 5 && createuser -s nexus 2>/dev/null || true && createdb -O nexus nexus_db 2>/dev/null || true && psql -c \"ALTER USER nexus WITH PASSWORD 'nexus_secure_2024';\" 2>/dev/null || true && psql -d nexus_db -c 'CREATE EXTENSION IF NOT EXISTS vector;' 2>/dev/null || true"
user=postgres
autostart=true
autorestart=false
startsecs=0
startretries=3
redirect_stderr=true
stdout_logfile=/var/log/supervisor/postgresql-setup.log
depends_on=postgresql

[program:redis]
command=redis-server --appendonly yes --appendfsync everysec --maxmemory 512mb --maxmemory-policy allkeys-lru --timeout 300 --tcp-keepalive 300 --tcp-backlog 511 --maxclients 1000
user=redis
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/supervisor/redis.log

[program:adminer]
command=/bin/bash -c "cd /var/www/html && php -S 0.0.0.0:8080"
user=www-data
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/supervisor/adminer.log
environment=ADMINER_DEFAULT_SERVER="localhost",ADMINER_DEFAULT_USER="nexus",ADMINER_DEFAULT_PASSWORD="nexus_secure_2024",ADMINER_DEFAULT_DB="nexus_db"
depends_on=postgresql

[program:redis-commander]
command=redis-commander --port 8081 --redis-host localhost --redis-port 6379
user=vscode
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/supervisor/redis-commander.log
environment=HTTP_USER="admin",HTTP_PASSWORD="redis_dev_2024"
depends_on=redis